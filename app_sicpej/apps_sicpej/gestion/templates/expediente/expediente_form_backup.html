{% extends 'sicpej/base.html' %}

{% block title %}Nuevo expediente: Paquete #{{ paquete.clave_expediente|default_if_none:paquete.numero_paquete }}
 {% endblock %}

{% block content %}
{% include "paquete/paquete_breadcrumb.html" %}

<div class="col-md-12">
  <div class="card">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h5 class="mb-0">{{ titulo }}: Paquete #{{ paquete.clave_expediente|default_if_none:expediente.numero_paquete }}
</h5>
      
          <span style="font-size: 1.15em;">
            <b>Juzgado:</b>{{ paquete.juzgado.nombre }}, {{ paquete.juzgado.municipio.descripcion }}
            <br>
            <b>Archivo regional:</b> {{ paquete.archivo_regional.nombre }}
          </span>
      
    </div>
    <div class="card-body">

<div class="bs-stepper wizard-numbered">
  <div class="bs-stepper-header">
    {% for etapa_nombre, fields in form.etapas %}
      <div class="step" data-target="#step{{ forloop.counter }}">
        <button type="button" class="step-trigger">
          <span class="bs-stepper-circle">
            <i class="icon-base ri ri-check-line"></i>
          </span>
          <span class="bs-stepper-label">
            {# Número con ceros: 01, 02, 03… #}
            <span class="bs-stepper-number">
              {{ forloop.counter|stringformat:"02d" }}
            </span>
            <span class="d-flex flex-column gap-1 ms-2">
              <span class="bs-stepper-title">{{ etapa_nombre }}</span>
              <span class="bs-stepper-subtitle">
                {{ etapa_nombre }}
              </span>
            </span>
          </span>
        </button>
      </div>

      {% if not forloop.last %}
        <div class="line"></div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="bs-stepper-content">
    <form method="post">
      {% csrf_token %}

      {% for etapa_nombre, fields in form.etapas %}
        <div id="step{{ forloop.counter }}" class="content">
          <div class="content-header mb-3">
            <h6 class="mb-0">{{ etapa_nombre }}</h6>
            <small>Ingrese datos de {{ etapa_nombre|lower }}.</small>
          </div>

          <div class="row g-5">
            {% for field in fields %}
              
              {% if field.name in 'expediente_toca juicio_delito' %}
                  <hr class="mt-5 mb-5">
              {% endif %}

              {% if field.name in 'instancia' %}
              <div class="col-12">
                <h6 class="mt-2">1. Datos jurisdiccionales </h6>
              </div>
              {% endif %}
              
              {% if field.name in 'expediente_toca' %}
              <div class="col-12">
                <h6 class="mt-2">2. Expediente </h6>
              </div>
              {% endif %}

              {% if field.name in 'juicio_delito' %}
              <div class="col-12">
                <h6 class="mt-2">3. Datos generales </h6>
              </div>
              {% endif %}

                {% if field.name in form.one_column_fields %}
                  <div class="col-12 mb-5">
                {% elif field.name in form.two_column_fields %}
                  <div class="col-md-6 mb-5">
                {% elif field.name in form.three_column_fields %}
                  <div class="col-md-4 mb-5">
                {% elif field.name in form.four_column_fields %}
                  <div class="col-md-3 mb-5">
                {% else %}
                  <div class="col-12 mb-5">
                {% endif %}
                  
                  {% if field.name in form.date_field_names %}
                    <div class="form-floating form-floating-outline">
                      <input type="text"
                          class="form-control {% if field.errors %}is-invalid{% endif %}"
                          placeholder="YYYY-MM-DD"
                          id="flatpickr-{{ field.name }}"
                          name="{{ field.name }}"
                          value="{{ field.value|date:'Y-m-d' }}">
                      <label for="flatpickr-{{ field.name }}">{{ field.label }}</label>
                    </div>
            
                  {% elif field.name in form.boolean_field_names %}
                    <div class="form-check form-switch mt-2">
                      <input type="checkbox" name="{{ field.name }}" id="{{ field.id_for_label }}"
                          class="form-check-input {% if field.errors %}is-invalid{% endif %}"
                          {% if field.value %}checked{% endif %}>

                          <label class="form-check-label" for="{{ field.id_for_label }}">
                              {% if field.name == 'tomo' %}
                                  ¿Es tomo?
                              {% elif field.name == 'acumulado' %}
                                  ¿Es acumulado?
                              {% elif field.name == 'concluido' %}
                                  ¿Concluido?
                              {% else %}
                                  {{ field.label }}
                              {% endif %}
                          </label>
                    </div>
            
                  {% elif field.name in "instancia materia tipo_juicio distrito_judicial municipio juzgado" %}
                    <select name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-select {% if field.errors %}is-invalid{% endif %} select2" required>
                      {% for value, label in field.field.choices %}
                        <option value="{{ value }}" {% if value == field.value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
            
                  {% else %}
                    {{ field }}
                  {% endif %}
            
                  {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                  {% endif %}
            
                  {% for error in field.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                  {% endfor %}
                </div>

              

            {% endfor %}

            <div class="col-12 d-flex justify-content-between">
              {# Botón “Anterior” (deshabilitado en el primer paso) #}
              <button
                type="button"
                class="btn btn-outline-secondary btn-prev"
                {% if forloop.first %}disabled{% endif %}
              >
                <i class="icon-base ri ri-arrow-left-line icon-sm scaleX-n1-rtl me-sm-1 me-0"></i>
                <span class="align-middle d-sm-inline-block d-none">Anterior</span>
              </button>

              {% if not forloop.last %}
                {# Botón “Siguiente” #}
                <button type="button" class="btn btn-primary btn-next">
                  <span class="align-middle d-sm-inline-block d-none me-sm-1">Siguiente</span>
                  <i class="icon-base ri ri-arrow-right-line icon-sm"></i>
                </button>
              {% else %}
                {# Último paso → botón “Enviar” #}
                <button type="submit" class="btn btn-primary btn-submit">
                  Enviar
                </button>
              {% endif %}
            </div>
          </div>


        </div>
      {% endfor %}

    </form>
  </div>



</div>

      
  {% for etapa_nombre, fields in form.etapas %}
    <div class="mb-4">
      <h5>{{ etapa_nombre }}</h5>
      <div class="row">
        {% for field in fields %}
          <div class="col-md-6 mb-3">
            <label for="{{ field.id_for_label }}" class="form-label"><strong>{{ field.label }}</strong></label>
            {{ field }}
            {% for error in field.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}

      <form method="post">
        {% csrf_token %}
        
        <div class="row">
            {% for field in form %}
              
              {% if field.name in 'expediente_toca juicio_delito' %}
                  <hr class="mt-5 mb-5">
              {% endif %}

              {% if field.name in 'instancia' %}
              <div class="col-12">
                <h6 class="mt-2">1. Datos jurisdiccionales </h6>
              </div>
              {% endif %}
              
              {% if field.name in 'expediente_toca' %}
              <div class="col-12">
                <h6 class="mt-2">2. Expediente </h6>
              </div>
              {% endif %}

              {% if field.name in 'juicio_delito' %}
              <div class="col-12">
                <h6 class="mt-2">3. Datos generales </h6>
              </div>
              {% endif %}

                {% if field.name in form.one_column_fields %}
                  <div class="col-12 mb-5">
                {% elif field.name in form.two_column_fields %}
                  <div class="col-md-6 mb-5">
                {% elif field.name in form.three_column_fields %}
                  <div class="col-md-4 mb-5">
                {% elif field.name in form.four_column_fields %}
                  <div class="col-md-3 mb-5">
                {% else %}
                  <div class="col-12 mb-5">
                {% endif %}
                  
                  {% if field.name not in form.boolean_field_names %}
                      <label for="{{ field.id_for_label }}" class="form-label" style="font-weight:800;">
                          {{ field.label }}
                      </label>
                  {% endif %}

                  {% if field.name in form.date_field_names %}
                    <div class="form-floating form-floating-outline">
                      <input type="text"
                          class="form-control {% if field.errors %}is-invalid{% endif %}"
                          placeholder="YYYY-MM-DD"
                          id="flatpickr-{{ field.name }}"
                          name="{{ field.name }}"
                          value="{{ field.value|date:'Y-m-d' }}">
                      <label for="flatpickr-{{ field.name }}">{{ field.label }}</label>
                    </div>
            
                  {% elif field.name in form.boolean_field_names %}
                    <div class="form-check form-switch mt-2">
                      <input type="checkbox" name="{{ field.name }}" id="{{ field.id_for_label }}"
                          class="form-check-input {% if field.errors %}is-invalid{% endif %}"
                          {% if field.value %}checked{% endif %}>

                          <label class="form-check-label" for="{{ field.id_for_label }}">
                              {% if field.name == 'tomo' %}
                                  ¿Es tomo?
                              {% elif field.name == 'acumulado' %}
                                  ¿Es acumulado?
                              {% elif field.name == 'concluido' %}
                                  ¿Concluido?
                              {% else %}
                                  {{ field.label }}
                              {% endif %}
                          </label>
                    </div>
            
                  {% elif field.name in "instancia materia tipo_juicio distrito_judicial municipio juzgado" %}
                    <select name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-select {% if field.errors %}is-invalid{% endif %} select2" required>
                      {% for value, label in field.field.choices %}
                        <option value="{{ value }}" {% if value == field.value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
            
                  {% else %}
                    {{ field }}
                  {% endif %}
            
                  {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                  {% endif %}
            
                  {% for error in field.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                  {% endfor %}
                </div>

              

            {% endfor %}
          </div>
        
        <div class="row justify-content-end">
            <div class="col-sm-12 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary waves-effect waves-light me-2">{{ accion }}</button>
                <a href="javascript:history.back()" class="btn btn-secondary">Cancelar</a>
            </div>
        </div>

      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
      const flatpickrInstances = {};
      const config = [
        { trigger: 'id_tomo', target: 'id_numero_tomo', wrapper: 'wrapper_numero_tomo' },
        { trigger: 'id_concluido', target: 'flatpickr-fecha_concluido', wrapper: 'wrapper_fecha_concluido', isDate: true },
        { trigger: 'id_acumulado', target: 'id_numero_acumulado', wrapper: 'wrapper_numero_acumulado' }
      ];
  
      // Inicializa todos los flatpickr
      document.querySelectorAll("input[id^='flatpickr-']").forEach(function (input) {
        const instance = flatpickr(input, {
          dateFormat: "Y-m-d",
          monthSelectorType: "static",
          static: true
        });
        flatpickrInstances[input.id] = instance;
      });
  
      // Activa lógica de switches
      config.forEach(({ trigger, target, wrapper, isDate }) => {
        const triggerEl = document.getElementById(trigger);
        const targetEl = document.getElementById(target);
        const wrapperEl = document.getElementById(wrapper);
        const flatpickrInstance = isDate ? flatpickrInstances[target] : null;
  
        function toggleTarget() {
          const enabled = triggerEl.checked;

          if (isDate && flatpickrInstance) {
            flatpickrInstance.set('disabled', !enabled);
            targetEl.disabled = !enabled;

            // Hacer requerido si está habilitado
            if (enabled) {
              targetEl.setAttribute('required', '');
            } else {
              targetEl.removeAttribute('required');
            }
          }

          if (targetEl && !isDate) {
            targetEl.disabled = !enabled;

            // Hacer requerido si está habilitado
            if (enabled) {
              targetEl.setAttribute('required', '');
            } else {
              targetEl.removeAttribute('required');
            }
          }

          if (wrapperEl) {
            wrapperEl.classList.toggle('d-none', !enabled);
          }
        }
  
        if (triggerEl && targetEl) {
          toggleTarget(); // Estado inicial
          triggerEl.addEventListener('change', toggleTarget);
        }
      });
    });


    const wizardNumbered = document.querySelector('.wizard-numbered'),
  wizardNumberedBtnNextList = [].slice.call(wizardNumbered.querySelectorAll('.btn-next')),
    wizardNumberedBtnPrevList = [].slice.call(wizardNumbered.querySelectorAll('.btn-prev')),
    wizardNumberedBtnSubmit = wizardNumbered.querySelector('.btn-submit');

if (typeof wizardNumbered !== undefined && wizardNumbered !== null) {
  const numberedStepper = new Stepper(wizardNumbered, {
    linear: false
  });
  if (wizardNumberedBtnNextList) {
    wizardNumberedBtnNextList.forEach(wizardNumberedBtnNext => {
      wizardNumberedBtnNext.addEventListener('click', event => {
        numberedStepper.next();
      });
    });
  }
  if (wizardNumberedBtnPrevList) {
    wizardNumberedBtnPrevList.forEach(wizardNumberedBtnPrev => {
      wizardNumberedBtnPrev.addEventListener('click', event => {
        numberedStepper.previous();
      });
    });
  }
  if (wizardNumberedBtnSubmit) {
    wizardNumberedBtnSubmit.addEventListener('click', event => {
      alert('Submitted..!!');
    });
  }
}
  </script>
  


{% endblock %}
